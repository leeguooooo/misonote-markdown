# ä¼ä¸šç‰ˆä¸“ç”¨ Dockerfile - åŒ…å«åŠ å¯†çš„ä¼ä¸šç‰ˆä»£ç 
FROM node:18-alpine AS base

# å®‰è£…å¿…è¦çš„ç³»ç»Ÿä¾èµ–
RUN apk add --no-cache libc6-compat

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å¤åˆ¶ package æ–‡ä»¶å’Œé…ç½®æ–‡ä»¶
COPY package.json pnpm-lock.yaml* .pnpmrc pnpm-workspace.yaml ./
COPY scripts/install.sh ./scripts/

# å®‰è£… pnpm
RUN npm install -g pnpm

# ä½¿ç”¨ä¸€é”®å®‰è£…å‘½ä»¤ï¼ˆè‡ªåŠ¨å¤„ç†æ„å»ºè„šæœ¬ï¼‰
RUN chmod +x scripts/install.sh && \
    SKIP_POSTINSTALL=true pnpm install --frozen-lockfile && \
    (echo "a" | pnpm approve-builds || echo "æ„å»ºè„šæœ¬å·²å¤„ç†")

# æ„å»ºé˜¶æ®µ - ä¼ä¸šç‰ˆ
FROM base AS builder

# å¤åˆ¶æºä»£ç ï¼ˆåŒ…å«ä¼ä¸šç‰ˆï¼‰
COPY . .

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV NODE_ENV=production
ENV NEXT_TELEMETRY_DISABLED=1
ENV MISONOTE_EDITION=enterprise

# ç”Ÿæˆé»˜è®¤ç¯å¢ƒå˜é‡ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
RUN if [ ! -f .env ]; then \
    echo "# Docker ä¼ä¸šç‰ˆç¯å¢ƒé…ç½®" > .env && \
    echo "NODE_ENV=production" >> .env && \
    echo "PORT=3001" >> .env && \
    echo "MISONOTE_EDITION=enterprise" >> .env && \
    echo "# ä¼ä¸šç‰ˆè®¸å¯è¯å¯†é’¥" >> .env && \
    echo "# MISONOTE_LICENSE_KEY=your_license_key" >> .env && \
    echo "# ç®¡ç†å‘˜å¯†ç å°†åœ¨é¦–æ¬¡å¯åŠ¨æ—¶è®¾ç½®" >> .env; \
    fi

# ğŸ”’ SECURITY: åŠ å¯†ä¼ä¸šç‰ˆä»£ç ï¼ˆå¦‚æœåŠ å¯†è„šæœ¬å­˜åœ¨ï¼‰
RUN if [ -f scripts/encrypt-enterprise.js ]; then \
    echo "åŠ å¯†ä¼ä¸šç‰ˆä»£ç ..." && \
    node scripts/encrypt-enterprise.js; \
    else \
    echo "è­¦å‘Š: ä¼ä¸šç‰ˆä»£ç æœªåŠ å¯†"; \
    fi

# Docker ç¯å¢ƒä¸‹ä½¿ç”¨ä¼ä¸šç‰ˆæ„å»ºæµç¨‹
ENV DOCKER_BUILD=true
RUN pnpm prebuild:docker && pnpm build:enterprise

# ğŸ”’ SECURITY: æ„å»ºåæ¸…ç†æ•æ„Ÿæ–‡ä»¶
RUN rm -rf scripts/encrypt-enterprise.js || true
RUN rm -rf .env.example || true

# ç”Ÿäº§è¿è¡Œé˜¶æ®µ
FROM node:18-alpine AS runner

# å®‰è£…å¿…è¦çš„ç³»ç»Ÿä¾èµ–
RUN apk add --no-cache libc6-compat bash

# åˆ›å»ºé root ç”¨æˆ·
RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å®‰è£… pnpm
RUN npm install -g pnpm

# å¤åˆ¶å¿…è¦æ–‡ä»¶
COPY --from=builder /app/public ./public
COPY --from=builder /app/.next/standalone ./
COPY --from=builder /app/.next/static ./.next/static
COPY --from=builder /app/package.json ./package.json
COPY --from=builder /app/scripts ./scripts
COPY --from=builder /app/ecosystem.config.js ./ecosystem.config.js

# ğŸ”’ SECURITY: å¤åˆ¶åŠ å¯†çš„ä¼ä¸šç‰ˆæ¨¡å—ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
COPY --from=builder /app/.next/enterprise-modules.encrypted ./.next/ || true

# è®¾ç½®å¯åŠ¨è„šæœ¬æƒé™
RUN chmod +x scripts/docker-entrypoint.sh

# åˆ›å»ºå¿…è¦çš„ç›®å½•
RUN mkdir -p docs data logs
RUN chown -R nextjs:nodejs /app

# åˆ‡æ¢åˆ°é root ç”¨æˆ·
USER nextjs

# æš´éœ²ç«¯å£
EXPOSE 3001

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV NODE_ENV=production
ENV HOSTNAME="0.0.0.0"
ENV PORT=3001
ENV MISONOTE_EDITION=enterprise

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD node healthcheck.js

# è®¾ç½®å…¥å£ç‚¹å’Œå¯åŠ¨å‘½ä»¤
ENTRYPOINT ["./scripts/docker-entrypoint.sh"]
CMD ["node", "server.js"]
