# ğŸ§ª æµ‹è¯•æŒ‡å—

æœ¬é¡¹ç›®ä½¿ç”¨ Vitest ä½œä¸ºæµ‹è¯•æ¡†æ¶ï¼Œç¡®ä¿ä»£ç è´¨é‡å’ŒåŠŸèƒ½ç¨³å®šæ€§ã€‚

## ğŸ“‹ æµ‹è¯•ç­–ç•¥

### æµ‹è¯•ç±»å‹

1. **å•å…ƒæµ‹è¯•** - æµ‹è¯•ç‹¬ç«‹çš„å‡½æ•°å’Œæ¨¡å—
2. **é›†æˆæµ‹è¯•** - æµ‹è¯•APIè·¯ç”±å’Œæ•°æ®åº“äº¤äº’
3. **æ„å»ºæµ‹è¯•** - éªŒè¯åº”ç”¨èƒ½å¤Ÿæ­£ç¡®æ„å»º
4. **å®‰å…¨æµ‹è¯•** - æ£€æŸ¥ä¾èµ–æ¼æ´å’Œå®‰å…¨é—®é¢˜

### æµ‹è¯•è¦†ç›–èŒƒå›´

- âœ… **API Key ç®¡ç†** - åˆ›å»ºã€éªŒè¯ã€æ›´æ–°ã€åˆ é™¤
- âœ… **æ•°æ®åº“æ“ä½œ** - è¿æ¥ã€äº‹åŠ¡ã€å¤‡ä»½ã€æ¸…ç†
- âœ… **API è·¯ç”±** - è®¤è¯ã€æƒé™ã€é”™è¯¯å¤„ç†
- ğŸ”„ **ç³»ç»Ÿè®¾ç½®** - é…ç½®ç®¡ç†ï¼ˆè®¡åˆ’ä¸­ï¼‰
- ğŸ”„ **ç”¨æˆ·è®¤è¯** - JWTã€å¯†ç éªŒè¯ï¼ˆè®¡åˆ’ä¸­ï¼‰

## ğŸš€ è¿è¡Œæµ‹è¯•

### åŸºæœ¬å‘½ä»¤

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pnpm test

# è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
pnpm test:coverage

# ç›‘å¬æ¨¡å¼è¿è¡Œæµ‹è¯•
pnpm test:watch

# è¿è¡Œæµ‹è¯•UIç•Œé¢
pnpm test:ui

# è¿è¡Œä¸€æ¬¡æ€§æµ‹è¯•ï¼ˆCIç¯å¢ƒï¼‰
pnpm test:run
```

### è¿è¡Œç‰¹å®šæµ‹è¯•

```bash
# è¿è¡ŒAPI Keyç›¸å…³æµ‹è¯•
pnpm test api-keys

# è¿è¡Œæ•°æ®åº“æµ‹è¯•
pnpm test database

# è¿è¡ŒAPIè·¯ç”±æµ‹è¯•
pnpm test api/admin
```

## ğŸ“ æµ‹è¯•æ–‡ä»¶ç»“æ„

```
tests/
â”œâ”€â”€ setup.ts                    # æµ‹è¯•ç¯å¢ƒè®¾ç½®
â”œâ”€â”€ utils/
â”‚   â””â”€â”€ test-database.ts       # æµ‹è¯•æ•°æ®åº“å·¥å…·
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â””â”€â”€ api-keys.test.ts   # API Keyå•å…ƒæµ‹è¯•
â”‚   â””â”€â”€ database/
â”‚       â””â”€â”€ database.test.ts    # æ•°æ®åº“åŠŸèƒ½æµ‹è¯•
â””â”€â”€ api/
    â””â”€â”€ admin/
        â””â”€â”€ api-keys.test.ts   # APIè·¯ç”±é›†æˆæµ‹è¯•
```

## ğŸ”§ æµ‹è¯•é…ç½®

### ç¯å¢ƒå˜é‡

æµ‹è¯•ç¯å¢ƒä½¿ç”¨ç‹¬ç«‹çš„é…ç½®ï¼š

```bash
NODE_ENV=test
JWT_SECRET=test-jwt-secret
ADMIN_PASSWORD_HASH_BASE64=<test-hash>
```

### æ•°æ®åº“

- æµ‹è¯•ä½¿ç”¨ç‹¬ç«‹çš„SQLiteæ•°æ®åº“æ–‡ä»¶
- æ¯ä¸ªæµ‹è¯•å‰åè‡ªåŠ¨æ¸…ç†æ•°æ®
- æ”¯æŒäº‹åŠ¡å’Œå¤–é”®çº¦æŸæµ‹è¯•

## âœï¸ ç¼–å†™æµ‹è¯•

### å•å…ƒæµ‹è¯•ç¤ºä¾‹

```typescript
import { describe, it, expect, beforeEach } from 'vitest'
import { createApiKey } from '@/core/api/api-keys'
import { cleanTestDatabase } from '../utils/test-database'

describe('API Key åˆ›å»º', () => {
  beforeEach(() => {
    cleanTestDatabase()
  })

  it('åº”è¯¥æˆåŠŸåˆ›å»ºAPIå¯†é’¥', () => {
    const result = createApiKey({
      name: 'Test Key',
      permissions: ['read', 'write']
    })

    expect(result.apiKey.name).toBe('Test Key')
    expect(result.secretKey).toMatch(/^mcp_[a-zA-Z0-9]{32}$/)
  })
})
```

### é›†æˆæµ‹è¯•ç¤ºä¾‹

```typescript
import { describe, it, expect } from 'vitest'
import { NextRequest } from 'next/server'
import { POST } from '@/app/api/admin/api-keys/route'

describe('API Keys API', () => {
  it('åº”è¯¥åˆ›å»ºæ–°çš„APIå¯†é’¥', async () => {
    const request = new NextRequest('http://localhost/api/admin/api-keys', {
      method: 'POST',
      headers: { 
        'Authorization': `Bearer ${testToken}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        name: 'Test Key',
        permissions: ['read']
      })
    })

    const response = await POST(request)
    const data = await response.json()

    expect(response.status).toBe(201)
    expect(data.success).toBe(true)
  })
})
```

## ğŸ¯ æµ‹è¯•æœ€ä½³å®è·µ

### 1. æµ‹è¯•å‘½å

- ä½¿ç”¨æè¿°æ€§çš„æµ‹è¯•åç§°
- é‡‡ç”¨ "åº”è¯¥...å½“..." çš„æ ¼å¼
- ä¸­æ–‡æè¿°æ›´æ¸…æ™°æ˜“æ‡‚

### 2. æµ‹è¯•éš”ç¦»

- æ¯ä¸ªæµ‹è¯•å‰æ¸…ç†æ•°æ®åº“
- ä¸ä¾èµ–å…¶ä»–æµ‹è¯•çš„çŠ¶æ€
- ä½¿ç”¨ç‹¬ç«‹çš„æµ‹è¯•æ•°æ®

### 3. æ–­è¨€æ¸…æ™°

- ä¸€ä¸ªæµ‹è¯•åªéªŒè¯ä¸€ä¸ªåŠŸèƒ½ç‚¹
- ä½¿ç”¨å…·ä½“çš„æ–­è¨€è€Œéé€šç”¨æ£€æŸ¥
- æä¾›æœ‰æ„ä¹‰çš„é”™è¯¯ä¿¡æ¯

### 4. æ¨¡æ‹Ÿå’Œå­˜æ ¹

- å¯¹å¤–éƒ¨ä¾èµ–è¿›è¡Œæ¨¡æ‹Ÿ
- ä½¿ç”¨çœŸå®æ•°æ®åº“è¿›è¡Œé›†æˆæµ‹è¯•
- é¿å…ç½‘ç»œè¯·æ±‚å’Œæ–‡ä»¶ç³»ç»Ÿæ“ä½œ

## ğŸ” è°ƒè¯•æµ‹è¯•

### æŸ¥çœ‹æµ‹è¯•è¾“å‡º

```bash
# è¯¦ç»†è¾“å‡º
pnpm test --reporter=verbose

# åªæ˜¾ç¤ºå¤±è´¥çš„æµ‹è¯•
pnpm test --reporter=basic

# ç”ŸæˆHTMLæŠ¥å‘Š
pnpm test:coverage
open coverage/index.html
```

### è°ƒè¯•å•ä¸ªæµ‹è¯•

```bash
# è¿è¡Œç‰¹å®šæµ‹è¯•æ–‡ä»¶
pnpm test tests/core/api/api-keys.test.ts

# è¿è¡Œç‰¹å®šæµ‹è¯•ç”¨ä¾‹
pnpm test -t "åº”è¯¥æˆåŠŸåˆ›å»ºAPIå¯†é’¥"
```

## ğŸ“Š CI/CD é›†æˆ

### GitHub Actions

æµ‹è¯•åœ¨ä»¥ä¸‹æƒ…å†µè‡ªåŠ¨è¿è¡Œï¼š

- æ¨é€åˆ° main/master åˆ†æ”¯
- åˆ›å»ºæˆ–æ›´æ–° Pull Request
- æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ

### æµ‹è¯•é˜¶æ®µ

1. **ä»£ç æ£€æŸ¥** - TypeScript å’Œ ESLint
2. **å•å…ƒæµ‹è¯•** - æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•
3. **é›†æˆæµ‹è¯•** - API å’Œæ•°æ®åº“æµ‹è¯•
4. **æ„å»ºæµ‹è¯•** - éªŒè¯åº”ç”¨æ„å»º
5. **å®‰å…¨æ£€æŸ¥** - ä¾èµ–æ¼æ´æ‰«æ

### åˆå¹¶è¦æ±‚

æ‰€æœ‰æµ‹è¯•å¿…é¡»é€šè¿‡æ‰èƒ½åˆå¹¶åˆ°ä¸»åˆ†æ”¯ï¼š

- âœ… TypeScript ç¼–è¯‘æ— é”™è¯¯
- âœ… ESLint æ£€æŸ¥é€šè¿‡
- âœ… å•å…ƒæµ‹è¯•é€šè¿‡ç‡ 100%
- âœ… é›†æˆæµ‹è¯•é€šè¿‡
- âœ… æ„å»ºæˆåŠŸ
- âœ… æ— é«˜å±å®‰å…¨æ¼æ´

## ğŸš¨ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **æ•°æ®åº“é”å®š**
   ```bash
   # æ¸…ç†æµ‹è¯•æ•°æ®åº“
   rm -rf tests/data/
   ```

2. **ç«¯å£å ç”¨**
   ```bash
   # æ£€æŸ¥ç«¯å£ä½¿ç”¨
   lsof -i :3001
   ```

3. **ä¾èµ–é—®é¢˜**
   ```bash
   # é‡æ–°å®‰è£…ä¾èµ–
   rm -rf node_modules pnpm-lock.yaml
   pnpm install
   ```

### è·å–å¸®åŠ©

- æŸ¥çœ‹æµ‹è¯•æ—¥å¿—äº†è§£å¤±è´¥åŸå› 
- ä½¿ç”¨ `pnpm test:ui` è¿›è¡Œå¯è§†åŒ–è°ƒè¯•
- æ£€æŸ¥ GitHub Actions çš„è¯¦ç»†è¾“å‡º

## ğŸ“ˆ æµ‹è¯•æŒ‡æ ‡

ç›®æ ‡æµ‹è¯•è¦†ç›–ç‡ï¼š

- **è¯­å¥è¦†ç›–ç‡**: > 80%
- **åˆ†æ”¯è¦†ç›–ç‡**: > 75%
- **å‡½æ•°è¦†ç›–ç‡**: > 85%
- **è¡Œè¦†ç›–ç‡**: > 80%

å½“å‰é‡ç‚¹æµ‹è¯•æ¨¡å—ï¼š

- API Key ç®¡ç† (100% è¦†ç›–)
- æ•°æ®åº“æ“ä½œ (95% è¦†ç›–)
- API è·¯ç”± (90% è¦†ç›–)
